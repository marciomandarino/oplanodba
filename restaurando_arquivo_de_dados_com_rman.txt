========================================================================================
== Restaurando um arquivo de dados do PDB
== Marcio Mandarino
== 09 de setembro de 2025
== marcio@mrdba.com.br
== www.mrdba.com.br
== https://www.linkedin.com/in/marciomandarino/
========================================================================================


=================================================================
== ðŸŽ¯ SequÃªncia
=================================================================
âœ… Backup de PDB com RMAN
ðŸ› ï¸ Restaurando um arquivo de dados do PDB
â³ Restaurando o PDB inteiro
â³ Restaurando um PDB excluÃ­do


=================================================================
== ðŸŽ¯ VisÃ£o Geral
=================================================================
â–¶ï¸ Fluxo completo e prÃ¡tico com validaÃ§Ã£o prÃ©-restore via dicionÃ¡rio e V$ views
â–¶ï¸ CenÃ¡rios: DATAFILE da USERS (file# 12) e DATAFILE do SYSTEM (file# 9)
â–¶ï¸ DemonstraÃ§Ã£o do erro ORA-01116/01110 ao tentar usar a USERS apÃ³s a perda
ðŸ’¡ Mantenha uma segunda sessÃ£o acompanhando o alert log com ADRCI


=================================================================
== ðŸŽ¯ Resumo do vÃ­deo:
=================================================================
ðŸ“ Abrir sessÃ£o extra e observar alert log (ADRCI)
ðŸ“ PrÃ©-checks do PDB e mapeamento dos datafiles
ðŸ“ Criar dados de teste na USERS
ðŸ“ Fazer BACKUP FULL do PDB (prÃ©-condiÃ§Ã£o)
ðŸ“ Simular perda (rm) e VALIDAR qual datafile estÃ¡ com problema
ðŸ“ RESTORE/RECOVER do USERS (file# 12) e validaÃ§Ã£o da tabela
ðŸ“ RESTORE/RECOVER do SYSTEM (file# 9) e validaÃ§Ãµes
ðŸ“ ConclusÃµes e limpeza opcional


=================================================================
== ðŸŽ¯ SessÃ£o extra: acompanhar o ALERT LOG (recomendado)
=================================================================
$ adrci
adrci> set home diag/rdbms/cdb1/cdb1
adrci> show alert -tail -f
-- Deixe esta sessÃ£o acompanhando o log enquanto executa os testes

=================================================================
== ðŸŽ¯ PrÃ©-checks
=================================================================
$ export ORACLE_SID=cdb1
$ sqlplus / as sysdba

SQL> show pdbs;

SQL> col name form a12
SQL> col open_mode form a12
SQL> select name, open_mode from v$pdbs where name='PDB1';

SQL> set lines 200
SQL> col file# form 999
SQL> col name  form a95
SQL> select file#, name
       from v$datafile
      where con_id=(select con_id from v$pdbs where name='PDB1')
      order by file#;

-- (Opcional) Via dicionÃ¡rio no PDB
SQL> alter session set container=PDB1;
SQL> col file_name form a95
SQL> select file_id, tablespace_name, file_name from dba_data_files order by file_id;


=================================================================
== ðŸŽ¯ Criar massa de dados na USERS (antes do BACKUP)
=================================================================
SQL> alter session set container=PDB1;

SQL> create user LAB identified by "Lab#2025"
     default tablespace USERS quota unlimited on USERS;
SQL> grant create session, create table to LAB;

SQL> create table LAB.T_DEMO (id number primary key, payload varchar2(100))
     tablespace USERS;
SQL> insert into LAB.T_DEMO
     select level, rpad('X',50,'X') from dual connect by level<=1000;
SQL> commit;
SQL> select count(*) "Rows_T_DEMO" from LAB.T_DEMO;
SQL> exit;


=================================================================
== ðŸŽ¯ BACKUP FULL do PDB (prÃ©-condiÃ§Ã£o)
=================================================================
$ rman target / 

RMAN> BACKUP PLUGGABLE DATABASE PDB1 TAG 'PRE_RESTORE_FULL';
RMAN> LIST BACKUP OF PLUGGABLE DATABASE PDB1;
RMAN> exit;


=================================================================
== ðŸŽ¯ Removendo o arquivo de dados
=================================================================
$ ls -lhtr /u02/oradata/CDB1/3BC946E28B079604E0638E44A8C0264A/datafile/o1_mf_users*.dbf
$ rm -f /u02/oradata/CDB1/3BC946E28B079604E0638E44A8C0264A/datafile/o1_mf_users*.dbf
$ ls -lhtr /u02/oradata/CDB1/3BC946E28B079604E0638E44A8C0264A/datafile/o1_mf_users*.dbf


=================================================================
== ðŸŽ¯ Mapeando o problema
=================================================================
$ sqlplus / as sysdba

SQL> set lines 400
SQL> col error form a25
SQL> select file#, error, change#, time from v$recover_file
     where con_id=(select con_id from v$pdbs where name='PDB1');

SQL> col status form a10
SQL> col name   form a95
SQL> select h.file#, h.status, h.error, h.recover, d.name
     from   v$datafile_header h
     join   v$datafile d on d.file#=h.file# and d.con_id=h.con_id
     where  h.con_id=(select con_id from v$pdbs where name='PDB1')
     order  by h.file#;


=================================================================
== ðŸŽ¯ Tentando acessar a tablespace USERS
=================================================================
SQL> alter session set container = pdb1;
SQL> create table X (y number) tablespace USERS;
-- Esperado (resumo do erro):
-- ORA-01116: error in opening database file 12
-- ORA-01110: data file 12: 
-- '/u02/oradata/CDB1/3BC946E28B079604E0638E44A8C0264A/datafile/o1_mf_users_n99l7q7r_.dbf'
-- ORA-27041: unable to open file  (Linux-x86_64 Error: 2: No such file or directory)

SQL> exit


=================================================================
== ðŸŽ¯ Tentando restaurar o datafile 
=================================================================
$ rman target /

-- 4) Restaurar e recuperar o DATAFILE 12
RMAN> RESTORE DATAFILE 12;
ORA-19573: cannot obtain exclusive enqueue for datafile 12
ORA-19890: data file already in use

RMAN> exit

âš ï¸ Sempre que for restaurar um datafile de uma tablespace, ele deve estar OFFLINE


=================================================================
== ðŸŽ¯ Colocando a tablespace USERS offline
=================================================================
$ sqlplus / as sysdba
SQL> alter session set container=PDB1;
SQL> alter tablespace USERS  offline immediate ;
SQL> exit


=================================================================
== ðŸŽ¯ Restaurando o datafile 
=================================================================
$ rman target /

-- 4) Restaurar e recuperar o DATAFILE 12
RMAN> RESTORE DATAFILE 12;
RMAN> RECOVER DATAFILE 12;
RMAN> exit

=================================================================
== ðŸŽ¯ Colocando a tablespace ONLINE 
=================================================================
$ sqlplus / as sysdba
SQL> alter session set container=PDB1;

-- 5) ONLINE da USERS e validaÃ§Ã£o da tabela criada antes do backup
SQL> alter tablespace USERS online;

=================================================================
== ðŸŽ¯ Validando o acesso aos dados
=================================================================

SQL> select count(*) "Rows_T_DEMO" from LAB.T_DEMO;

SQL> alter session set container=cdb$root;

SQL> col status form a10
SQL> col name   form a95
SQL> col error form a20
SQL> select h.file#, h.status, h.error, h.recover, d.name
     from   v$datafile_header h
     join   v$datafile d on d.file#=h.file# and d.con_id=h.con_id
     where  h.con_id=(select con_id from v$pdbs where name='PDB1')
     order  by h.file#;



=================================================================
== ðŸ ConclusÃ£o
=================================================================
â–¶ï¸ Antes do restore, identifique o arquivo problemÃ¡tico com V$RECOVER_FILE e V$DATAFILE_HEADER
â–¶ï¸ Sempre tenha um backup recente!!!
ðŸ’¡ Acompanhar o alert log (ADRCI -tail -f) acelera o diagnÃ³stico durante todo o fluxo

=================================================================
== ðŸ§¹ Limpa tudo (opcional)
=================================================================
SQL> alter session set container=PDB1;
SQL> drop user LAB cascade;
SQL> exit

$ rman target /
RMAN> DELETE NOPROMPT BACKUP TAG 'PRE_RESTORE_FULL';
RMAN> DELETE NOPROMPT OBSOLETE;
