========================================================================================
== Restaurando o PDB inteiro
== Marcio Mandarino
== 09 de setembro de 2025
== marcio@mrdba.com.br
== www.mrdba.com.br
== https://www.linkedin.com/in/marciomandarino/
========================================================================================

=================================================================
== ðŸŽ¯ Resumo do vÃ­deo:
=================================================================
ðŸ“ SequÃªncia
ðŸ“ VisÃ£o Geral
ðŸ“ Resumo do vÃ­deo
ðŸ“ SessÃ£o extra: acompanhar o ALERT LOG (recomendado)
ðŸ“ Criar massa de dados (antes do BACKUP)
ðŸ“ BACKUP FULL do PDB (prÃ©-condiÃ§Ã£o)
ðŸ“ Simulando perda total de datafiles do PDB
ðŸ“ RESTORE/RECOVER do PDB inteiro
ðŸ“ Reabertura do PDB e validaÃ§Ãµes
ðŸ“ ConclusÃ£o
ðŸ“ Limpa tudo (opcional)



=================================================================
== ðŸŽ¯ SequÃªncia
=================================================================
âœ… Backup de PDB com RMAN
âœ… Restaurando um arquivo de dados do PDB
ðŸ› ï¸ Restaurando o PDB inteiro
â³ Restaurando um PDB excluÃ­do


=================================================================
== ðŸŽ¯ VisÃ£o Geral
=================================================================
â–¶ï¸ Objetivo: restaurar o PDB completo a partir de backup, apÃ³s perda do um owner


=================================================================
== ðŸŽ¯ SessÃ£o extra: acompanhar o ALERT LOG (recomendado)
=================================================================
$ adrci
adrci> set home diag/rdbms/cdb1/cdb1
adrci> show alert -tail -f
-- Deixe esta sessÃ£o acompanhando o log enquanto executa os testes



=================================================================
== ðŸŽ¯ Criar massa de dados (antes do BACKUP)
=================================================================
$ sqlplus / as sysdba
SQL> alter session set container=PDB1;

-- UsuÃ¡rio e tabela de validaÃ§Ã£o do PDB
SQL> create user LABPDB identified by "Lab#2025"
     default tablespace USERS quota unlimited on USERS;
SQL> grant create session, create table to LABPDB;

SQL> create table LABPDB.T_PDB (id number primary key, payload varchar2(100))
     tablespace USERS;

SQL> insert into LABPDB.T_PDB
     select level, rpad('Y',60,'Y') from dual connect by level<=2000;
SQL> commit;

SQL> select count(*) "Rows_T_PDB" from LABPDB.T_PDB;
SQL> exit


=================================================================
== ðŸŽ¯ BACKUP FULL do PDB (prÃ©-condiÃ§Ã£o)
=================================================================
$ rman target /

RMAN> BACKUP PLUGGABLE DATABASE PDB1 TAG 'before_update';
RMAN> LIST BACKUP OF PLUGGABLE DATABASE PDB1;
RMAN> exit


=================================================================
== ðŸŽ¯ Simulando perda total de datafiles do PDB
=================================================================
$ sqlplus / as sysdba
SQL> alter session set container = pdb1;
SQL> select to_char(sysdate,'DD/MM/RRRR HH24:MI:SS'), CURRENT_SCN from v$database;
SQL> create restore point myrestpoint;
SQL> drop user LABPDB cascade;
SQL> exit


=================================================================
== ðŸŽ¯ RESTORE/RECOVER do PDB inteiro
=================================================================
RMAN> ALTER PLUGGABLE DATABASE PDB1 close;

RUN 
{ 
     SET UNTIL SCN 2944784; 
     RESTORE PLUGGABLE DATABASE PDB1; 
     RECOVER PLUGGABLE DATABASE PDB1; 
}

RMAN> ALTER PLUGGABLE DATABASE PDB1 open resetlogs; 
RMAN> exit;


=================================================================
== ðŸŽ¯ Reabertura do PDB e validaÃ§Ãµes
=================================================================
$ sqlplus / as sysdba

SQL> alter session set container=PDB1;
SQL> select count(*) "Rows_T_PDB" from LABPDB.T_PDB;

SQL> exit


=================================================================
== ðŸ ConclusÃ£o
=================================================================
â–¶ï¸ Possuindo um backup vÃ¡lido, Ã© possÃ­vel restaurar um PDB inteiro 
â–¶ï¸ Existem vÃ¡rios cenÃ¡rios de recuperaÃ§Ã£o, esse Ã© UM deles


=================================================================
== ðŸ§¹ Limpa tudo (opcional)
=================================================================
SQL> alter session set container=PDB1;
SQL> drop user LABPDB cascade;
SQL> exit

$ rman target /
RMAN> DELETE NOPROMPT BACKUP TAG 'before_update';
RMAN> DELETE NOPROMPT OBSOLETE;
