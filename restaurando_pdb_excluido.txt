========================================================================================
== Restaurando um PDB excluÃ­do
== Marcio Mandarino
== 09 de setembro de 2025
== marcio@mrdba.com.br
== www.mrdba.com.br
== https://www.linkedin.com/in/marciomandarino/
========================================================================================

=================================================================
== ðŸŽ¯ Resumo do vÃ­deo:
=================================================================
ðŸ“ SequÃªncia
ðŸ“ VisÃ£o Geral
ðŸ“ SessÃ£o extra: acompanhar o ALERT LOG
ðŸ“ PrÃ©-checks e criaÃ§Ã£o de dados (antes do BACKUP)
ðŸ“ BACKUP FULL do PDB (prÃ©-condiÃ§Ã£o)
ðŸ“ Dropar o PDB (simulando exclusÃ£o acidental)
ðŸ“ Criando um diretÃ³rio auxiliar
ðŸ“ RESTORE/RECOVER do PDB excluÃ­do (PDB PITR)
ðŸ“ ValidaÃ§Ãµes pÃ³s-restauraÃ§Ã£o
ðŸ“ ConclusÃ£o
ðŸ“ Limpa tudo (opcional)


=================================================================
== ðŸŽ¯ SequÃªncia
=================================================================
âœ… Backup de PDB com RMAN
âœ… Restaurando um arquivo de dados do PDB
âœ… Restaurando o PDB inteiro
ðŸ› ï¸ Restaurando um PDB excluÃ­do


=================================================================
== ðŸŽ¯ VisÃ£o Geral
=================================================================
â–¶ï¸ Restaurar um PDB que foi Ã© um processo que envolve a criaÃ§Ã£o de uma instÃ¢ncia auxiliar
â–¶ï¸ Esse processo vai demorar de acorodo com o tamanho do PDB


=================================================================
== ðŸŽ¯ SessÃ£o extra: acompanhar o ALERT LOG (recomendado)
=================================================================
$ adrci
adrci> set home diag/rdbms/cdb1/cdb1
adrci> show alert -tail -f
-- Deixe esta sessÃ£o acompanhando o log enquanto executa os testes


=================================================================
== ðŸŽ¯ PrÃ©-checks e criaÃ§Ã£o de dados (antes do BACKUP)
=================================================================
$ sqlplus / as sysdba
SQL> show pdbs;

SQL> col name form a12
SQL> col open_mode form a12
SQL> select name, open_mode from v$pdbs where name='PDB1';

SQL> alter session set container=PDB1;

-- UsuÃ¡rio e tabela para validaÃ§Ã£o apÃ³s o restore
SQL> create user LABPDB identified by "Lab#2025"
     default tablespace USERS quota unlimited on USERS;
SQL> grant create session, create table to LABPDB;

SQL> create table LABPDB.T_PDB (id number primary key, payload varchar2(100))
     tablespace USERS;

SQL> insert into LABPDB.T_PDB
     select level, rpad('Y',60,'Y') from dual connect by level<=2000;
SQL> commit;

SQL> select count(*) "Rows_T_PDB" from LABPDB.T_PDB;
SQL> exit


=================================================================
== ðŸŽ¯ BACKUP FULL do PDB (prÃ©-condiÃ§Ã£o)
=================================================================
$ rman target /

RMAN> BACKUP DATABASE PLUS ARCHIVELOG;
RMAN> exit

ðŸ’¡ AlÃ©m do backup do PDB, Ã© preciso que haja um backup do container root


=================================================================
== ðŸŽ¯ Dropar o PDB (simulando exclusÃ£o acidental)
=================================================================
$ sqlplus / as sysdba
SQL> show pdbs;

SQL> alter session set NLS_DATE_FORMAT='DD-MM-RRRR HH24:MI:SS';


SQL> select sysdate from dual; 
SQL> alter pluggable database pdb1 close;
SQL> drop pluggable database pdb1 including datafiles;


=================================================================
== ðŸŽ¯ Criando um diretÃ³rio auxiliar
=================================================================
$ mkdir /tmp/pdb1/


=================================================================
== ðŸŽ¯ RESTORE/RECOVER do PDB excluÃ­do (PDB PITR)
=================================================================
$ rman target /

RMAN> recover pluggable database pdb1 until time "to_date('09-09-2025 16:11:06','DD-MM-RRRR HH24:MI:SS')" auxiliary destination '/tmp/pdb1/';


=================================================================
== ðŸŽ¯ ValidaÃ§Ãµes pÃ³s-restauraÃ§Ã£o
=================================================================
$ sqlplus / as sysdba

-- PDB deve estar aberto
SQL> select name, open_mode from v$pdbs where name='PDB1';

-- Conferir que os dados â€œvoltaramâ€ ao estado anterior ao DROP
SQL> alter session set container=PDB1;
SQL> select count(*) "Rows_T_PDB" from LABPDB.T_PDB;

-- (Opcional) Salvar o estado para auto-open apÃ³s restart
SQL> alter pluggable database PDB1 save state;

-- (Opcional) Checar pendÃªncias de recovery
SQL> alter session set container=cdb$root;
SQL> select file#, error, change#, time
       from v$recover_file
      where con_id=(select con_id from v$pdbs where name='PDB1');

SQL> exit



=================================================================
== ðŸ ConclusÃ£o
=================================================================
â–¶ï¸ Mesmo com PDB DROP INCLUDING DATAFILES, Ã© possÃ­vel recuperÃ¡-lo via PDB PITR (UNTIL SCN)
â–¶ï¸ O RMAN restaura o PDB usando um destino auxiliar e exige OPEN RESETLOGS ao final
â–¶ï¸ Valide com contagens e consultas para comprovar a integridade dos objetos restaurados


=================================================================
== ðŸ§¹ Limpa tudo (opcional)
=================================================================
$ sqlplus / as sysdba
SQL> alter session set container=PDB1;
SQL> drop user LABPDB cascade;
SQL> exit

$ rm -rf /tmp/pdb1/