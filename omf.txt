========================================================================================
== Oracle Managed Files (OMF)
== Marcio Mandarino
== 06 de agosto de 2025
== marcio@mrdba.com.br
== www.mrdba.com.br
== https://www.linkedin.com/in/marciomandarino/
========================================================================================


ðŸŒŽ ReferÃªncias  
https://docs.oracle.com/en/database/oracle/oracle-database/19/admin/oraasm/oracle-managed-files.html  
https://docs.oracle.com/en/database/oracle/oracle-database/19/admin/managing-online-redo-logs.html  




=================================================================
== ðŸŽ¯ Resumo do vÃ­deo
=================================================================
ðŸ“ VisÃ£o Geral
ðŸ“ DB_CREATE_FILE_DEST
ðŸ“ DB_CREATE_ONLINE_LOG_DEST_n
ðŸ“ ConclusÃ£o
ðŸ“ Limpa tudo


=================================================================
== ðŸŽ¯ VisÃ£o Geral
=================================================================
â–¶ï¸ O Oracle Managed Files (OMF) automatiza nomeaÃ§Ã£o e localizaÃ§Ã£o de arquivos  
â–¶ï¸ Simplifica criaÃ§Ã£o e gerÃªncia de datafiles e redo logs  
â–¶ï¸ Requer configuraÃ§Ã£o de parÃ¢metros DB_CREATE_FILE_DEST e DB_CREATE_ONLINE_LOG_DEST_n  
â–¶ï¸ Suporta tanto filesystem quanto ASM diskgroups  
ðŸ’¡ NÃ£o precisa reiniciar o banco para as configuraÃ§Ãµes entrarem em vigor
âš ï¸ Mesmo com o OMF confiugurado, vocÃª pode especificar manualmente o nome dos arquivos
*

=================================================================
== ðŸŽ¯ DB_CREATE_FILE_DEST
=================================================================
â–¶ï¸ Define o destino padrÃ£o para criaÃ§Ã£o automÃ¡tica de datafiles e tempfiles
â–¶ï¸ O arquivo de dados (Caminho e nome) serÃ£o criados automaticamente no caminho do DB_CREATE_FILE_DEST
ðŸ’¡ Se por alguma razÃ£o quiser criar arquivos de dados em outra localidade, especifique manualmente

-- Exemplo para ambientes que usam File System
SQL> ALTER SYSTEM SET DB_CREATE_FILE_DEST = '/u02/oradata' SCOPE=BOTH;


-- Criando tablespace usando OMF
SQL> CREATE TABLESPACE tbs_omf DATAFILE SIZE 100M;  
SQL> CREATE TEMPORARY TABLESPACE tbs_omf_temp; 

-- Criando tablespace sem OMF
SQL> CREATE TABLESPACE tbs_normal DATAFILE '/u03/oradata/CDB1/datafile/tbs_normal.dbf' size 100m;
CREATE TABLESPACE tbs_normal DATAFILE '/u03/oradata/CDB1/datafile/tbs_normal.dbf' size 100m
*
ERROR at line 1:
ORA-01119: error in creating database file '/u03/oradata/CDB1/datafile/tbs_normal.dbf'
ORA-27040: file create error, unable to create file
Linux-x86_64 Error: 2: No such file or directory
Additional information: 1

âš ï¸ O diretÃ³rio deve existir e o usuÃ¡rio do oracle deve ter permissÃ£o de gravaÃ§Ã£o

SQL> !mkdir /u03/oradata/CDB1/datafile
SQL> CREATE TABLESPACE tbs_normal DATAFILE '/u03/oradata/CDB1/datafile/tbs_normal.dbf' size 100m;



-- Incluindo um datafile usando OMF
SQL> ALTER TABLESPACE  tbs_normal add datafile size 100m;



SQL> set lines 400
SQL> col FILE_NAME form a80
SQL> select tablespace_name, FILE_NAME from dba_data_files where tablespace_name like 'TBS%';
SQL> select tablespace_name, FILE_NAME from dba_temp_files where tablespace_name like 'TBS_OMF%';

ðŸ’¡ Ã‰ importante notar que o Oracle cria uma estrutura dentro do diretÃ³rio do OMF

=================================================================
== ðŸŽ¯ DB_CREATE_ONLINE_LOG_DEST_n
=================================================================
â–¶ï¸ O Oracle cria automaticamente membros de redo logs em cada destino configurado  
â–¶ï¸ MultiplexaÃ§Ã£o aumenta disponibilidade e proteÃ§Ã£o contra falhas de disco  

$ mkdir -p /u02/oradata/redo/ /u03/oradata/redo/

-- Exemplo para ambientes que usam File System
SQL> ALTER SYSTEM SET DB_CREATE_ONLINE_LOG_DEST_1 = '/u02/oradata/redo' SCOPE=BOTH;
SQL> ALTER SYSTEM SET DB_CREATE_ONLINE_LOG_DEST_2 = '/u03/oradata/redo' SCOPE=BOTH;


SQL> ALTER DATABASE ADD LOGFILE GROUP 10 size 200M;
SQL> ALTER DATABASE ADD LOGFILE size 200M; 

SQL> col a.group# form 999
SQL> col thread# form 999
SQL> col "Size (GB)" form 999,99.99
SQL> col status form a30
SQL> col MEMBER form a80


SQL> SELECT a.group#,
       thread#,
       bytes / 1024 / 1024 / 1024 "Size (GB)",
       a.status,
       MEMBER
  FROM v$log a, v$logfile b
 WHERE a.group# = b.group#
 order by 1,2;
*


=================================================================
== ðŸŽ¯ Ambientes com ASM
=================================================================
â–¶ï¸ O OMF funciona do mesmo jeito em ambientes com ASM

SQL> ALTER SYSTEM SET DB_CREATE_FILE_DEST = '+DATA' SCOPE=BOTH;
SQL> ALTER SYSTEM SET DB_CREATE_ONLINE_LOG_DEST_2 = '+FRA' SCOPE=BOTH;
SQL> ALTER SYSTEM SET DB_CREATE_ONLINE_LOG_DEST_3 = '+FRA' SCOPE=BOTH;


SQL> CREATE TABLESPACE tbs_omf DATAFILE SIZE 100M;  
SQL> CREATE TEMPORARY TABLESPACE tbs_omf_temp; 

SQL> set lines 400
SQL> col FILE_NAME form a80
SQL> select tablespace_name, FILE_NAME from dba_data_files where tablespace_name like 'TBS%';
SQL> select tablespace_name, FILE_NAME from dba_temp_files where tablespace_name like 'TBS_OMF%';

SQL> ALTER DATABASE ADD LOGFILE GROUP 10 size 200M;
SQL> ALTER DATABASE ADD LOGFILE size 200M; 

SQL> col a.group# form 999
SQL> col thread# form 999
SQL> col "Size (GB)" form 999,99.99
SQL> col status form a30
SQL> col MEMBER form a80


SQL> SELECT a.group#,
       thread#,
       bytes / 1024 / 1024 / 1024 "Size (GB)",
       a.status,
       MEMBER
  FROM v$log a, v$logfile b
 WHERE a.group# = b.group#
 order by 1,2;




=================================================================
== ðŸ ConclusÃ£o
=================================================================
â–¶ï¸ OMF simplifica criaÃ§Ã£o e manutenÃ§Ã£o de arquivos Oracle  
â–¶ï¸ Suporta tanto filesystem quanto ASM diskgroups  
â–¶ï¸ Permite multiplexaÃ§Ã£o de redo logs de forma transparente  
â–¶ï¸ Reduz necessidade de gestÃ£o manual de paths e nomes de arquivos  


=================================================================
== ðŸ§¹ Limpa tudo
=================================================================
SQL> drop tablespace tbs_omf including contents and datafiles;
SQL> drop tablespace tbs_omf_temp including contents and datafiles;
SQL> drop tablespace tbs_normal including contents and datafiles;
SQL> ALTER DATABASE DROP LOGFILE GROUP 4;
SQL> ALTER DATABASE DROP LOGFILE GROUP 10;
SQL> ALTER SYSTEM RESET DB_CREATE_FILE_DEST SCOPE=BOTH;
SQL> ALTER SYSTEM RESET DB_CREATE_ONLINE_LOG_DEST_1 SCOPE=BOTH;
SQL> ALTER SYSTEM RESET DB_CREATE_ONLINE_LOG_DEST_2 SCOPE=BOTH;